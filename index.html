<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conte IA</title>
<style>
  :root {
    --bg:       #0f0f13;
    --surface:  #1a1a24;
    --surface2: #22222f;
    --border:   #2e2e42;
    --accent:   #7c6af7;
    --accent2:  #a78bfa;
    --text:     #e8e8f0;
    --text2:    #9898b0;
    --success:  #4ade80;
    --warning:  #fbbf24;
    --radius:   12px;
    --font:     'Segoe UI', system-ui, sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px 60px;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    width: 100%;
    max-width: 860px;
    text-align: center;
    margin-bottom: 32px;
  }
  header h1 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }
  header p { color: var(--text2); font-size: .95rem; }

  /* â”€â”€ Progress bar â”€â”€ */
  #progress-wrap {
    width: 100%;
    max-width: 860px;
    margin-bottom: 28px;
  }
  .progress-steps {
    display: flex;
    gap: 6px;
    align-items: center;
    overflow-x: auto;
    padding-bottom: 4px;
  }
  .step-pill {
    flex-shrink: 0;
    padding: 5px 14px;
    border-radius: 99px;
    font-size: .75rem;
    font-weight: 600;
    background: var(--surface2);
    color: var(--text2);
    border: 1px solid var(--border);
    transition: all .3s;
  }
  .step-pill.done   { background: #2a2a3d; color: var(--accent2); border-color: var(--accent); }
  .step-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .step-arrow { color: var(--border); font-size: .8rem; flex-shrink: 0; }

  /* â”€â”€ Card â”€â”€ */
  .card {
    width: 100%;
    max-width: 860px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 20px;
  }
  .card h2 {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 18px;
    color: var(--accent2);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .card h2 .icon { font-size: 1.4rem; }

  /* â”€â”€ Select â”€â”€ */
  select {
    width: 100%;
    padding: 12px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 1rem;
    font-family: var(--font);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%239898b0' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }
  select:focus { outline: none; border-color: var(--accent); }

  input[type=text],
  input[type=password] {
    width: 100%;
    padding: 12px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: .95rem;
    font-family: var(--font);
  }
  input[type=text]:focus,
  input[type=password]:focus { outline: none; border-color: var(--accent); }

  .field-label {
    display: block;
    font-size: .85rem;
    color: var(--text2);
    margin: 14px 0 8px;
  }

  /* â”€â”€ Botons â”€â”€ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 11px 24px;
    border-radius: 8px;
    font-size: .95rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all .2s;
    font-family: var(--font);
  }
  .btn-primary   { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #6b5be0; transform: translateY(-1px); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent2); }
  .btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); border-color: var(--text2); }
  .btn:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }
  .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }

  /* â”€â”€ Pills de selecciÃ³ (estil narratiu) â”€â”€ */
  .opts-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }
  .opt-pill {
    flex: 1;
    min-width: 130px;
    padding: 14px 16px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    text-align: center;
    font-size: .88rem;
    font-weight: 600;
    transition: all .2s;
    line-height: 1.4;
    user-select: none;
  }
  .opt-pill small {
    display: block;
    font-weight: 400;
    color: var(--text2);
    font-size: .75rem;
    margin-top: 4px;
  }
  .opt-pill:hover   { border-color: var(--accent); }
  .opt-pill.chosen  { border-color: var(--accent); background: #1e1b38; color: var(--accent2); }
  .opt-pill.chosen small { color: var(--accent2); }

  /* â”€â”€ Llista de premisses â”€â”€ */
  .premise-list { display: flex; flex-direction: column; gap: 10px; }
  .premise-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all .2s;
  }
  .premise-item:hover  { border-color: var(--accent); }
  .premise-item.chosen { border-color: var(--accent); background: #1e1b38; }
  .premise-item input[type=radio] { margin-top: 2px; accent-color: var(--accent); flex-shrink: 0; }
  .premise-item label { cursor: pointer; line-height: 1.5; font-size: .95rem; }

  /* â”€â”€ Badge Recomanat â”€â”€ */
  .badge-recomanat {
    display: inline-block;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    font-size: .68rem;
    font-weight: 700;
    padding: 2px 9px;
    border-radius: 99px;
    text-transform: uppercase;
    letter-spacing: .07em;
    margin-right: 8px;
    vertical-align: middle;
    flex-shrink: 0;
  }

  /* â”€â”€ Loader â”€â”€ */
  .loader-wrap {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 32px 0;
    color: var(--text2);
    font-size: .9rem;
  }
  .loader-wrap.visible { display: flex; }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Toast â”€â”€ */
  #toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 24px;
    border-radius: 99px;
    font-size: .9rem;
    transition: transform .3s;
    z-index: 9999;
    pointer-events: none;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€ Reader del conte â”€â”€ */
  .conte-reader {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 40px 48px;
    font-family: 'Georgia', 'Times New Roman', serif;
    font-size: 1.05rem;
    line-height: 1.9;
    color: var(--text);
    max-height: 72vh;
    overflow-y: auto;
  }
  .conte-reader p {
    margin-bottom: 1.1em;
    text-indent: 1.8em;
  }
  .conte-reader p:first-child { text-indent: 0; }
  @media (max-width: 600px) {
    .conte-reader { padding: 24px 20px; font-size: .97rem; }
  }
  .conte-wordcount {
    font-size: .78rem;
    color: var(--text2);
    margin-top: 10px;
    text-align: right;
  }

  /* â”€â”€ Millora â”€â”€ */
  .millora-row {
    display: flex;
    gap: 10px;
    margin-top: 14px;
  }
  .millora-row input {
    flex: 1;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: .9rem;
    font-family: var(--font);
  }
  .millora-row input:focus { outline: none; border-color: var(--accent); }
  .millora-row input::placeholder { color: var(--text2); }

  /* â”€â”€ Export â”€â”€ */
  .export-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--accent2);
    text-decoration: none;
    font-size: .9rem;
    font-weight: 600;
    padding: 8px 16px;
    border: 1px solid var(--accent);
    border-radius: 8px;
    transition: all .2s;
  }
  .export-link:hover { background: #1e1b38; }

  /* â”€â”€ SecciÃ³ amagada â”€â”€ */
  .hidden { display: none !important; }
</style>
</head>
<body>

<header>
  <h1>ğŸ“– Conte IA</h1>
  <p>Crea el teu conte pas a pas amb intelÂ·ligÃ¨ncia artificial</p>
</header>

<!-- CONFIGURACIÃ“ INICIAL -->
<div class="card" id="card-config">
  <h2><span class="icon">âš™ï¸</span> ConfiguraciÃ³</h2>
  <p style="color:var(--text2);margin-bottom:8px;">Configura el model d'IA abans de comenÃ§ar.</p>

  <label class="field-label" for="config-provider">ProveÃ¯dor</label>
  <select id="config-provider" onchange="actualitzarModelDefault()">
    <option value="anthropic">Anthropic (Claude)</option>
    <option value="openai">OpenAI (GPT-4o)</option>
    <option value="gemini">Google (Gemini 1.5)</option>
  </select>

  <label class="field-label" for="config-model">Model</label>
  <input type="text" id="config-model" placeholder="claude-opus-4-1" value="claude-opus-4-1">

  <label class="field-label" for="config-apikey">API Key</label>
  <input type="password" id="config-apikey" placeholder="Enganxa aquÃ­ la teva API key">

  <div class="btn-row">
    <button class="btn btn-primary" onclick="guardarIComencar()">Guardar i ComenÃ§ar</button>
  </div>
</div>

<!-- Progress -->
<div id="progress-wrap" class="hidden">
  <div class="progress-steps" id="steps-bar">
    <div class="step-pill active" data-step="0">GÃ¨nere</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="1">Premissa</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="2">Estil</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="3">Protagonista</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="4">Final</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="5">Escriptura</div>
  </div>
</div>

<!-- FASE 0: SelecciÃ³ de gÃ¨nere -->
<div class="card hidden" id="fase-0">
  <h2><span class="icon">ğŸ­</span> Tria el gÃ¨nere</h2>
  <label class="field-label" for="sel-tematica">Tipus de conte</label>
  <select id="sel-tematica">
    <option value="">â€” Selecciona un gÃ¨nere â€”</option>
    <option value="conte de terror psicolÃ²gic">Terror psicolÃ²gic</option>
    <option value="conte de realisme mÃ gic">Realisme mÃ gic</option>
    <option value="conte negre / noir">Conte negre / noir</option>
    <option value="conte de ciÃ¨ncia-ficciÃ³ breu">CiÃ¨ncia ficciÃ³</option>
    <option value="conte fantÃ stic">Conte fantÃ stic</option>
    <option value="faula contemporÃ nia">Faula contemporÃ nia</option>
    <option value="conte sentimental">Conte sentimental</option>
    <option value="conte d'humor negre">Humor negre</option>
    <option value="microconte / flash fiction">Microconte / flash fiction</option>
    <option value="conte de misteri">Misteri</option>
  </select>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="iniciarFase1()">âœ¨ Generar premisses</button>
  </div>
</div>

<!-- FASE 1: SelecciÃ³ de premissa -->
<div class="card hidden" id="fase-1">
  <h2><span class="icon">ğŸ’¡</span> Tria la premissa</h2>
  <div class="loader-wrap" id="loader-1">
    <div class="spinner"></div>
    <span>Generant 10 premissesâ€¦</span>
  </div>
  <div id="llista-premisses" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase1" onclick="iniciarFase2()">ğŸ¨ Triar estil narratiu</button>
  </div>
</div>

<!-- FASE 2: Estil narratiu (sense crida a LLM) -->
<div class="card hidden" id="fase-2">
  <h2><span class="icon">ğŸ¨</span> Estil narratiu</h2>
  <p style="color:var(--text2);font-size:.9rem;margin-bottom:4px;">Defineix el to, la perspectiva i la longitud del conte.</p>

  <label class="field-label">To i atmosfera</label>
  <select id="sel-to">
    <option value="">â€” Tria el to â€”</option>
    <option value="misteri i suspens creixent">Misteri i suspens</option>
    <option value="terror psicolÃ²gic i claustrofÃ²bic">Terror psicolÃ²gic</option>
    <option value="realisme mÃ gic poÃ¨tic">Realisme mÃ gic</option>
    <option value="humor negre i irÃ²nic">Humor negre</option>
    <option value="melancolia i bittersweet">Melancolia / bittersweet</option>
    <option value="thriller emocional d'alta tensiÃ³">Thriller emocional</option>
    <option value="tendresa i vulnerabilitat">Tendresa i vulnerabilitat</option>
    <option value="absurd i kafkiÃ ">Absurd / kafkiÃ </option>
    <option value="meravella i mÃ gia continguda">MÃ gia i meravella</option>
    <option value="rÃ bia i tensiÃ³ social">RÃ bia i tensiÃ³ social</option>
  </select>

  <label class="field-label">Perspectiva narrativa</label>
  <div class="opts-row" id="opts-perspectiva">
    <div class="opt-pill" data-group="perspectiva" data-val="primera persona (narrador protagonista)" onclick="triarPill(this)">
      1a persona
      <small>Jo narrador</small>
    </div>
    <div class="opt-pill" data-group="perspectiva" data-val="tercera persona limitada (focalitzaciÃ³ Ãºnica en el protagonista)" onclick="triarPill(this)">
      3a persona
      <small>FocalitzaciÃ³ Ãºnica</small>
    </div>
    <div class="opt-pill" data-group="perspectiva" data-val="segona persona (el lector Ã©s el protagonista)" onclick="triarPill(this)">
      2a persona
      <small>Tu ets el protagonista</small>
    </div>
  </div>

  <label class="field-label">Longitud del conte</label>
  <div class="opts-row" id="opts-paraules">
    <div class="opt-pill" data-group="paraules" data-val="500" onclick="triarPill(this)">
      Microconte
      <small>~500 paraules</small>
    </div>
    <div class="opt-pill" data-group="paraules" data-val="1500" onclick="triarPill(this)">
      Conte curt
      <small>~1.500 paraules</small>
    </div>
    <div class="opt-pill" data-group="paraules" data-val="3000" onclick="triarPill(this)">
      Conte llarg
      <small>~3.000 paraules</small>
    </div>
  </div>

  <div class="btn-row">
    <button class="btn btn-primary" onclick="iniciarFase3()">ğŸ‘¤ Triar protagonista</button>
  </div>
</div>

<!-- FASE 3: Protagonista -->
<div class="card hidden" id="fase-3">
  <h2><span class="icon">ğŸ‘¤</span> Tria el protagonista</h2>
  <div class="loader-wrap" id="loader-3">
    <div class="spinner"></div>
    <span>Generant protagonistesâ€¦</span>
  </div>
  <div id="llista-personatges" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase3" onclick="iniciarFase4()">ğŸ Triar el final</button>
  </div>
</div>

<!-- FASE 4: Finals -->
<div class="card hidden" id="fase-4">
  <h2><span class="icon">ğŸ</span> Tria el final</h2>
  <div class="loader-wrap" id="loader-4">
    <div class="spinner"></div>
    <span>Generant 5 finals possiblesâ€¦</span>
  </div>
  <div id="llista-finals" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase4" onclick="iniciarEscriptura()">âœï¸ Escriure el conte</button>
  </div>
</div>

<!-- FASE 5: Escriptura -->
<div class="card hidden" id="fase-5">
  <h2><span class="icon">âœï¸</span> El teu conte</h2>
  <div class="loader-wrap" id="loader-5">
    <div class="spinner"></div>
    <span id="loader-5-text">Escrivint el conteâ€¦</span>
  </div>
  <div id="conte-wrap" class="hidden">
    <div class="conte-reader" id="conte-cos"></div>
    <div class="conte-wordcount" id="conte-wordcount"></div>

    <!-- Millora -->
    <div class="millora-row">
      <input type="text" id="millora-input" placeholder="Vols millorar alguna cosa? (ex: Â«fes l'ending mÃ©s abrupteÂ»)">
      <button class="btn btn-secondary" onclick="millorarConte()">âœ¨ Millorar</button>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="regenerarConte()">ğŸ”„ Regenerar</button>
      <button class="btn btn-primary"   onclick="exportarDoc()">ğŸ“„ Exportar a Google Docs</button>
    </div>
    <div id="export-link-wrap" class="hidden" style="margin-top:14px;"></div>
  </div>
</div>


<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function showCard(id)  { document.getElementById(id).classList.remove('hidden'); }
function hideCard(id)  { document.getElementById(id).classList.add('hidden'); }
function showLoader(n) { document.getElementById('loader-' + n).classList.add('visible'); }
function hideLoader(n) { document.getElementById('loader-' + n).classList.remove('visible'); }
function showBtn(id)   { document.getElementById(id).classList.remove('hidden'); }

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3200);
}

function updateProgress(fase) {
  document.querySelectorAll('.step-pill').forEach(el => {
    const s = parseInt(el.dataset.step);
    el.classList.remove('active', 'done');
    if (s < fase)  el.classList.add('done');
    if (s === fase) el.classList.add('active');
  });
}

function compteParaules(text) {
  return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTAT GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let USER_CONFIG = null;

const ESTAT = {
  fase:             0,
  tematica:         '',
  history:          [],
  premissaTriada:   '',
  _premissaLista:   [],
  _premissaIdx:     undefined,
  estil: {
    to:          '',
    perspectiva: '',
    paraules:    1500,
    desc:        ''
  },
  _llistaProtagonistes: [],
  _idxProtagonista:     null,
  protagonistaTriat:    '',
  _llistaFinals:        [],
  _idxFinal:            null,
  finalTriat:           '',
  conteText:            ''
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURACIÃ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODEL_DEFAULTS = {
  anthropic: 'claude-opus-4-1',
  openai:    'gpt-4o',
  gemini:    'gemini-1.5-pro'
};

function actualitzarModelDefault() {
  const provider = document.getElementById('config-provider').value;
  const input    = document.getElementById('config-model');
  const def      = MODEL_DEFAULTS[provider] || '';
  input.placeholder = def;
  input.value       = def;
}

function guardarIComencar() {
  const provider = document.getElementById('config-provider').value;
  const model    = document.getElementById('config-model').value.trim();
  const apiKey   = document.getElementById('config-apikey').value.trim();
  if (!provider) { toast('Selecciona un proveÃ¯dor.'); return; }
  if (!model)    { toast('Introdueix el nom del model.'); return; }
  if (!apiKey)   { toast("Introdueix una API key."); return; }

  USER_CONFIG = { provider, apiKey, model };

  hideCard('card-config');
  document.getElementById('progress-wrap').classList.remove('hidden');
  showCard('fase-0');
  toast('ConfiguraciÃ³ guardada.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 0 â†’ FASE 1: Premisses
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase1() {
  const sel = document.getElementById('sel-tematica').value;
  if (!sel) { toast('Selecciona primer un gÃ¨nere.'); return; }
  if (!USER_CONFIG) { toast('Primer configura el model.'); return; }

  ESTAT.tematica = sel;
  ESTAT.history  = [];
  ESTAT.fase     = 1;
  updateProgress(1);
  showCard('fase-1');
  showLoader(1);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(1);
      renderPremisses(res.response);
    })
    .withFailureHandler(err => { hideLoader(1); toast('Error: ' + err.message); })
    .fase1_premisses(sel, [], USER_CONFIG);
}

// â”€â”€â”€ Render genÃ¨ric amb badge "Recomanat" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLlistaAmbRecomanat(text, wrapId, listaKey, idxKey, btnId) {
  const wrap  = document.getElementById(wrapId);
  const lines = text.split('\n').filter(l => /^\d+\./.test(l.trim()));
  if (lines.length === 0) {
    wrap.innerHTML = `<pre style="white-space:pre-wrap;font-size:.9rem;">${escHtml(text)}</pre>`;
    ESTAT[listaKey] = [];
    return;
  }
  const list = lines.map(l => l.replace(/^\d+\.\s*/, '').trim());
  // Guardar sense "(Recomanat)" per usar als prompts
  ESTAT[listaKey] = list.map(item => item.replace(/\s*\(Recomanat\)\s*/i, '').trim());
  ESTAT[idxKey]   = null;

  let autoIdx = null;
  wrap.innerHTML = list.map((item, i) => {
    const esRecomanat = /\(Recomanat\)/i.test(item);
    const textNet     = item.replace(/\s*\(Recomanat\)\s*/i, '').trim();
    if (esRecomanat) autoIdx = i;
    const badge = esRecomanat ? `<span class="badge-recomanat">Recomanat</span>` : '';
    return `<div class="premise-item" id="${wrapId}-item-${i}" onclick="triarItem('${wrapId}','${idxKey}',${i},this)">
      <input type="radio" name="${wrapId}-radio" id="${wrapId}-r-${i}">
      <label for="${wrapId}-r-${i}">${badge}${escHtml(textNet)}</label>
    </div>`;
  }).join('');

  // Auto-seleccionar el recomanat
  if (autoIdx !== null) {
    const el = document.getElementById(`${wrapId}-item-${autoIdx}`);
    if (el) {
      el.classList.add('chosen');
      el.querySelector('input').checked = true;
      ESTAT[idxKey] = autoIdx;
    }
  }
  showBtn(btnId);
}

function triarItem(wrapId, idxKey, idx, el) {
  document.querySelectorAll(`#${wrapId} .premise-item`).forEach(e => e.classList.remove('chosen'));
  el.classList.add('chosen');
  el.querySelector('input').checked = true;
  ESTAT[idxKey] = idx;
}

function renderPremisses(text) {
  renderLlistaAmbRecomanat(text, 'llista-premisses', '_premissaLista', '_premissaIdx', 'btn-fase1');
}

function triarPremissa(idx, el) { triarItem('llista-premisses', '_premissaIdx', idx, el); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 1 â†’ FASE 2: Estil (sense API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase2() {
  const idx = ESTAT._premissaIdx;
  if (idx === undefined || idx === null) { toast('Tria una premissa primer.'); return; }
  ESTAT.premissaTriada = ESTAT._premissaLista[idx];
  ESTAT.fase = 2;
  updateProgress(2);
  showCard('fase-2');
}

// Pills de selecciÃ³ (estil)
function triarPill(el) {
  const group = el.dataset.group;
  document.querySelectorAll(`.opt-pill[data-group="${group}"]`).forEach(p => p.classList.remove('chosen'));
  el.classList.add('chosen');
  const val = el.dataset.val;
  if (group === 'perspectiva') ESTAT.estil.perspectiva = val;
  if (group === 'paraules')    ESTAT.estil.paraules    = parseInt(val);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 2 â†’ FASE 3: Protagonista
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase3() {
  const to          = document.getElementById('sel-to').value;
  const perspectiva = ESTAT.estil.perspectiva;
  const paraules    = ESTAT.estil.paraules;

  if (!to)          { toast('Tria el to del conte.'); return; }
  if (!perspectiva) { toast('Tria la perspectiva narrativa.'); return; }
  if (!paraules)    { toast('Tria la longitud del conte.'); return; }

  ESTAT.estil.to  = to;
  ESTAT.estil.desc = `to "${to}", ${perspectiva}, ${paraules} paraules aproximades`;

  ESTAT.fase = 3;
  updateProgress(3);
  showCard('fase-3');
  showLoader(3);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(3);
      renderProtagonistes(res.response);
    })
    .withFailureHandler(err => { hideLoader(3); toast('Error: ' + err.message); })
    .fase3_personatges(ESTAT.premissaTriada, ESTAT.estil.desc, ESTAT.history, USER_CONFIG);
}

function renderProtagonistes(text) {
  renderLlistaAmbRecomanat(text, 'llista-personatges', '_llistaProtagonistes', '_idxProtagonista', 'btn-fase3');
}

function triarProtagonista(idx, el) { triarItem('llista-personatges', '_idxProtagonista', idx, el); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 3 â†’ FASE 4: Finals
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase4() {
  const idx = ESTAT._idxProtagonista;
  if (idx === null || idx === undefined || !ESTAT._llistaProtagonistes[idx]) {
    toast('Tria un protagonista primer.');
    return;
  }
  ESTAT.protagonistaTriat = ESTAT._llistaProtagonistes[idx];
  ESTAT.fase = 4;
  updateProgress(4);
  showCard('fase-4');
  showLoader(4);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(4);
      renderLlistaAmbRecomanat(res.response, 'llista-finals', '_llistaFinals', '_idxFinal', 'btn-fase4');
    })
    .withFailureHandler(err => { hideLoader(4); toast('Error: ' + err.message); })
    .fase4_finals(ESTAT.protagonistaTriat, ESTAT.estil.desc, ESTAT.history, USER_CONFIG);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 4 â†’ FASE 5: Escriptura
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarEscriptura() {
  const idx = ESTAT._idxFinal;
  if (idx === null || idx === undefined || !ESTAT._llistaFinals[idx]) {
    toast('Tria un final primer.');
    return;
  }
  ESTAT.finalTriat = ESTAT._llistaFinals[idx];
  ESTAT.fase = 5;
  updateProgress(5);
  showCard('fase-5');
  hideCard('conte-wrap');
  showLoader(5);
  document.getElementById('loader-5-text').textContent = 'Escrivint el conteâ€¦';
  document.getElementById('export-link-wrap').classList.add('hidden');

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history   = res.history;
      ESTAT.conteText = res.response;
      hideLoader(5);
      mostrarConte(res.response);
    })
    .withFailureHandler(err => { hideLoader(5); toast('Error: ' + err.message); })
    .escriureConte(
      ESTAT.protagonistaTriat,
      ESTAT.finalTriat,
      ESTAT.estil.desc,
      ESTAT.estil.paraules,
      ESTAT.history,
      USER_CONFIG
    );
}

function mostrarConte(text) {
  const cos  = document.getElementById('conte-cos');
  const pars = text.split(/\n\n+/).filter(p => p.trim().length > 0);
  cos.innerHTML = pars.map(p => `<p>${escHtml(p.trim())}</p>`).join('');

  const wc = compteParaules(text);
  document.getElementById('conte-wordcount').textContent = `${wc.toLocaleString('ca')} paraules`;

  showCard('conte-wrap');
  setTimeout(() => {
    document.getElementById('fase-5').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACCIONS SOBRE EL CONTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function regenerarConte() {
  if (!confirm('Vols regenerar el conte? El text actual es perdrÃ .')) return;
  ESTAT.history = ESTAT.history.slice(0, -2);
  hideCard('conte-wrap');
  showLoader(5);
  document.getElementById('loader-5-text').textContent = 'Regenerant el conteâ€¦';

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history   = res.history;
      ESTAT.conteText = res.response;
      hideLoader(5);
      mostrarConte(res.response);
    })
    .withFailureHandler(err => { hideLoader(5); toast('Error: ' + err.message); })
    .escriureConte(
      ESTAT.protagonistaTriat,
      ESTAT.finalTriat,
      ESTAT.estil.desc,
      ESTAT.estil.paraules,
      ESTAT.history,
      USER_CONFIG
    );
}

function millorarConte() {
  const instruccio = document.getElementById('millora-input').value.trim();
  if (!instruccio) { toast('Escriu una instrucciÃ³ de millora.'); return; }
  if (!ESTAT.conteText) { toast('Primer genera el conte.'); return; }

  hideCard('conte-wrap');
  showLoader(5);
  document.getElementById('loader-5-text').textContent = 'Aplicant la milloraâ€¦';

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history   = res.history;
      ESTAT.conteText = res.response;
      hideLoader(5);
      document.getElementById('millora-input').value = '';
      mostrarConte(res.response);
      toast('Millora aplicada.');
    })
    .withFailureHandler(err => { hideLoader(5); toast('Error: ' + err.message); })
    .millorarConte(instruccio, ESTAT.conteText, ESTAT.estil.desc, ESTAT.history, USER_CONFIG);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarDoc() {
  if (!ESTAT.conteText) { toast('No hi ha cap conte per exportar.'); return; }
  const titol = ESTAT.premissaTriada
    ? ESTAT.premissaTriada.substring(0, 55) + (ESTAT.premissaTriada.length > 55 ? 'â€¦' : '')
    : 'Conte IA';
  toast('Creant document a Google Docsâ€¦');

  google.script.run
    .withSuccessHandler(url => {
      const wrap = document.getElementById('export-link-wrap');
      wrap.innerHTML = `<a href="${url}" target="_blank" class="export-link">ğŸ“„ Obrir a Google Docs â†’</a>`;
      wrap.classList.remove('hidden');
    })
    .withFailureHandler(err => toast('Error: ' + err.message))
    .exportarADoc(titol, ESTAT.conteText);
}
</script>
</body>
</html>
