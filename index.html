<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traduccia</title>
  
  <!-- Mammoth.js per parsejar .docx -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- JSZip per generar EPUB -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- FileSaver per descarregar -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #16a34a;
      --success-light: #dcfce7;
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-light: #64748b;
      --danger: #dc2626;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 { font-size: 24px; font-weight: 700; color: var(--primary); }
    .header h1 span { color: var(--text-light); font-weight: 400; font-size: 14px; margin-left: 8px; }
    
    .tabs {
      display: flex;
      gap: 0;
      background: var(--surface);
      border-bottom: 2px solid var(--border);
      padding: 0 24px;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      font-weight: 500;
      color: var(--text-light);
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    .tab-content { display: none; padding: 24px; }
    .tab-content.active { display: block; }
    
    .config-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .config-section h2 { font-size: 16px; margin-bottom: 16px; color: var(--text); }
    .config-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .config-field { flex: 1; min-width: 200px; }
    .config-field label {
      display: block; font-size: 13px; font-weight: 500;
      margin-bottom: 6px; color: var(--text-light);
    }
    .config-field input,
    .config-field select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--border); border-radius: 8px;
      font-size: 14px; transition: border-color 0.2s;
    }
    .config-field input:focus,
    .config-field select:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .upload-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .upload-zone {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: rgba(37,99,235,0.02); }
    .upload-zone.loaded { border-color: var(--success); border-style: solid; background: var(--success-light); }
    .upload-zone h3 { font-size: 16px; margin-bottom: 8px; }
    .upload-zone p { font-size: 13px; color: var(--text-light); }
    .upload-zone .filename { font-weight: 600; color: var(--success); margin-top: 8px; font-size: 14px; }
    .upload-zone input[type="file"] { display: none; }
    
    .index-container {
      display: grid; grid-template-columns: 1fr auto 1fr; gap: 0;
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
    }
    .index-panel { padding: 16px; }
    .index-panel h3 {
      font-size: 14px; font-weight: 600; margin-bottom: 12px;
      padding-bottom: 8px; border-bottom: 1px solid var(--border);
    }
    .index-panel.original h3 { color: var(--primary); }
    .index-panel.traduccio h3 { color: var(--success); }
    
    .controls-panel {
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start; padding: 16px 12px; gap: 12px;
      border-left: 1px solid var(--border); border-right: 1px solid var(--border);
      padding-top: 50px;
    }
    
    .chapter-item {
      padding: 8px 12px; border-radius: 6px; cursor: pointer;
      font-size: 13px; display: flex; align-items: center; gap: 8px;
      transition: all 0.15s; border: 2px solid transparent;
    }
    .chapter-item:hover { background: var(--bg); }
    .chapter-item.selected { border-color: var(--primary); background: rgba(37,99,235,0.05); }
    .chapter-item .check {
      width: 22px; height: 22px; background: var(--success); border-radius: 50%;
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 12px; flex-shrink: 0;
    }
    .chapter-item .spinner {
      width: 22px; height: 22px; border: 2px solid var(--border);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 0.8s linear infinite; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .btn {
      padding: 10px 20px; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 500; cursor: pointer;
      transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: #15803d; }
    .btn-glossari { background: #7c3aed; color: white; }
    .btn-glossari:hover:not(:disabled) { background: #6d28d9; }
    
    .glossari-section {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 16px; margin-bottom: 20px;
    }
    .glossari-section h2 { font-size: 16px; margin-bottom: 12px; }
    .glossari-content {
      background: var(--bg); border-radius: 8px; padding: 12px;
      font-size: 13px; white-space: pre-wrap; max-height: 200px;
      overflow-y: auto; font-family: monospace;
    }
    .glossari-content.empty { color: var(--text-light); font-style: italic; font-family: inherit; }
    
    .translation-list {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden;
    }
    .translation-item {
      padding: 14px 20px; border-bottom: 1px solid var(--border);
      cursor: pointer; display: flex; align-items: center; gap: 12px;
      transition: background 0.15s;
    }
    .translation-item:last-child { border-bottom: none; }
    .translation-item:hover { background: var(--bg); }
    .translation-item .num {
      width: 28px; height: 28px; background: var(--primary); color: white;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 600; flex-shrink: 0;
    }
    .translation-item .title { font-weight: 500; }
    
    .epub-section { margin-top: 20px; text-align: center; }
    
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--surface); border-radius: 16px;
      width: 100%; max-width: 800px; max-height: 85vh;
      display: flex; flex-direction: column;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-header h2 { font-size: 18px; }
    .modal-close {
      width: 32px; height: 32px; border: none; background: var(--bg);
      border-radius: 8px; cursor: pointer; font-size: 18px; color: var(--text-light);
      display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { background: var(--border); }
    .modal-body { padding: 24px; overflow-y: auto; font-size: 15px; line-height: 1.7; }
    
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    
    .status-msg { padding: 10px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; display: none; }
    .status-msg.error { display: block; background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
    .status-msg.success { display: block; background: var(--success-light); color: var(--success); border: 1px solid #bbf7d0; }
  </style>
</head>
<body>

  <div class="header">
    <h1>Traduccia <span>Revisi√≥ de traduccions amb IA</span></h1>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('config')">‚öôÔ∏è Configuraci√≥</div>
    <div class="tab" onclick="switchTab('translations')">üìù Traduccions <span id="translationCount"></span></div>
  </div>
  
  <div style="padding: 24px 24px 0;">
    <div class="status-msg" id="statusMsg"></div>
  </div>
  
  <!-- Tab 1: Config -->
  <div class="tab-content active" id="tab-config">
    <div class="config-section">
      <h2>ü§ñ Configuraci√≥ de la IA</h2>
      <div class="config-row">
        <div class="config-field">
          <label>Prove√Ødor</label>
          <select id="proveidor">
            <option value="openai">OpenAI-compatible</option>
            <option value="anthropic">Anthropic</option>
          </select>
        </div>
        <div class="config-field">
          <label>Model</label>
          <input type="text" id="model" placeholder="gpt-4o / claude-sonnet-4-20250514">
        </div>
        <div class="config-field">
          <label>API Key</label>
          <input type="password" id="apiKey" placeholder="sk-...">
        </div>
      </div>
    </div>
    
    <div class="upload-container">
      <div class="upload-zone" id="uploadOriginal" onclick="document.getElementById('fileOriginal').click()">
        <h3>üìÑ Document Original</h3>
        <p>Arrossega o clica per pujar un .docx</p>
        <div class="filename" id="fnOriginal"></div>
        <input type="file" id="fileOriginal" accept=".docx" onchange="handleFile(this, 'original')">
      </div>
      <div class="upload-zone" id="uploadTraduccio" onclick="document.getElementById('fileTraduccio').click()">
        <h3>üìÑ Document Traducci√≥</h3>
        <p>Arrossega o clica per pujar un .docx</p>
        <div class="filename" id="fnTraduccio"></div>
        <input type="file" id="fileTraduccio" accept=".docx" onchange="handleFile(this, 'traduccio')">
      </div>
    </div>
    
    <div class="glossari-section" id="glossariSection" style="display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <h2>üìñ Glossari de Consist√®ncia</h2>
        <button class="btn btn-glossari" id="btnGlossari" onclick="generarGlossari()">üîç Generar Glossari</button>
      </div>
      <div class="glossari-content empty" id="glossariContent">
        Encara no s'ha generat cap glossari. Clica "Generar Glossari" per crear-ne un a partir dels primers cap√≠tols.
      </div>
    </div>
    
    <div class="index-container" id="indexContainer" style="display:none;">
      <div class="index-panel original">
        <h3>√çndex ‚Äî Original</h3>
        <div id="indexOriginal"></div>
      </div>
      <div class="controls-panel">
        <button class="btn btn-primary" id="btnRevisar" onclick="revisarSeleccio()" disabled>üîÑ Revisar Cap√≠tol</button>
      </div>
      <div class="index-panel traduccio">
        <h3>√çndex ‚Äî Traducci√≥</h3>
        <div id="indexTraduccio"></div>
      </div>
    </div>
  </div>
  
  <!-- Tab 2: Translations -->
  <div class="tab-content" id="tab-translations">
    <div id="translationsList">
      <div class="empty-state">
        <div class="icon">üì≠</div>
        <p>Encara no hi ha cap cap√≠tol revisat.<br>Ves a Configuraci√≥ per comen√ßar.</p>
      </div>
    </div>
    <div class="epub-section" id="epubSection" style="display:none;">
      <button class="btn btn-success" onclick="generarEPUB()" style="font-size:16px; padding:14px 32px;">üìö Generar EPUB</button>
    </div>
  </div>
  
  <!-- Modal -->
  <div class="modal-overlay" id="modal" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

<script>
  // ============================================================
  //  STATE ‚Äî Inicialitzaci√≥. La l√≤gica s'afegir√† en prompts 2-4.
  // ============================================================
  var state = {
    original: { chapters: [], html: '' },
    traduccio: { chapters: [], html: '' },
    selectedOriginal: null,
    selectedTraduccio: null,
    revisions: [],
    glossari: '',
    processing: {}
  };

  // ============================================================
  //  TABS
  // ============================================================
  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
    if (tab === 'config') {
      document.querySelectorAll('.tab')[0].classList.add('active');
      document.getElementById('tab-config').classList.add('active');
    } else {
      document.querySelectorAll('.tab')[1].classList.add('active');
      document.getElementById('tab-translations').classList.add('active');
    }
  }

  // ============================================================
  //  UTILS
  // ============================================================
  function showStatus(msg, type) {
    var el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.className = 'status-msg ' + type;
    if (type === 'success') {
      setTimeout(function() { el.className = 'status-msg'; }, 5000);
    }
  }

  function escapeXml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // ============================================================
  //  DRAG AND DROP
  // ============================================================
  ['uploadOriginal', 'uploadTraduccio'].forEach(function(id) {
    var zone = document.getElementById(id);
    zone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    zone.addEventListener('dragleave', function(e) {
      this.classList.remove('dragover');
    });
    zone.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      var type = id === 'uploadOriginal' ? 'original' : 'traduccio';
      var file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.docx')) {
        processFile(file, type);
      } else {
        showStatus('Nom√©s s\'accepten fitxers .docx', 'error');
      }
    });
  });

  // ============================================================
  //  FILE HANDLING
  // ============================================================
  function handleFile(input, type) {
    var file = input.files[0];
    if (file) processFile(file, type);
  }

  function processFile(file, type) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var arrayBuffer = e.target.result;
      mammoth.convertToHtml({arrayBuffer: arrayBuffer})
        .then(function(result) {
          var chapters = extractChapters(result.value);
          state[type].chapters = chapters;
          state[type].html = result.value;
          
          var zoneId = type === 'original' ? 'uploadOriginal' : 'uploadTraduccio';
          var fnId = type === 'original' ? 'fnOriginal' : 'fnTraduccio';
          document.getElementById(zoneId).classList.add('loaded');
          document.getElementById(fnId).textContent = '‚úÖ ' + file.name + ' (' + chapters.length + ' cap√≠tols)';
          
          renderIndexes();
          showStatus('Document "' + file.name + '" carregat correctament amb ' + chapters.length + ' cap√≠tols.', 'success');
        })
        .catch(function(err) {
          showStatus('Error processant el fitxer: ' + err.message, 'error');
        });
    };
    reader.readAsArrayBuffer(file);
  }

  // ============================================================
  //  CHAPTER EXTRACTION
  // ============================================================
  function extractChapters(html) {
    var parser = new DOMParser();
    var doc = parser.parseFromString('<div>' + html + '</div>', 'text/html');
    var body = doc.querySelector('div');
    var chapters = [];
    var currentChapter = null;
    
    for (var i = 0; i < body.childNodes.length; i++) {
      var node = body.childNodes[i];
      if (node.nodeType === 1) {
        var tag = node.tagName.toLowerCase();
        if (tag === 'h1' || tag === 'h2') {
          if (currentChapter) {
            chapters.push(currentChapter);
          }
          currentChapter = {
            titol: node.textContent.trim(),
            contingut: '',
            htmlContent: ''
          };
        } else if (currentChapter) {
          currentChapter.contingut += node.textContent + '\n';
          currentChapter.htmlContent += node.outerHTML;
        }
      }
    }
    if (currentChapter) {
      chapters.push(currentChapter);
    }
    
    // Si no hi ha headings, tractar tot com un sol cap√≠tol
    if (chapters.length === 0 && html.trim()) {
      chapters.push({
        titol: 'Document complet',
        contingut: body.textContent,
        htmlContent: html
      });
    }
    
    return chapters;
  }

  // ============================================================
  //  INDEX RENDERING
  // ============================================================
  function renderIndexes() {
    if (state.original.chapters.length === 0 && state.traduccio.chapters.length === 0) return;
    
    document.getElementById('indexContainer').style.display = '';
    document.getElementById('glossariSection').style.display = '';
    
    renderIndex('indexOriginal', state.original.chapters, 'original');
    renderIndex('indexTraduccio', state.traduccio.chapters, 'traduccio');
    updateRevisarButton();
  }

  function renderIndex(containerId, chapters, type) {
    var container = document.getElementById(containerId);
    container.innerHTML = '';
    
    chapters.forEach(function(ch, i) {
      var div = document.createElement('div');
      div.className = 'chapter-item';
      div.dataset.index = i;
      div.dataset.type = type;
      
      var label = document.createElement('span');
      label.textContent = (i + 1) + '. ' + ch.titol;
      label.style.flex = '1';
      div.appendChild(label);
      
      // Indicador de revisat (costat traducci√≥)
      if (type === 'traduccio') {
        var revised = state.revisions.find(function(r) { return r.indexTrad === i; });
        if (revised) {
          var check = document.createElement('span');
          check.className = 'check';
          check.textContent = '‚úì';
          div.appendChild(check);
        }
        if (state.processing['t' + i]) {
          var spinner = document.createElement('span');
          spinner.className = 'spinner';
          div.appendChild(spinner);
        }
      }
      if (type === 'original' && state.processing['o' + i]) {
        var spinner = document.createElement('span');
        spinner.className = 'spinner';
        div.appendChild(spinner);
      }
      
      div.onclick = function() { selectChapter(type, i); };
      container.appendChild(div);
    });
  }

  // ============================================================
  //  CHAPTER SELECTION
  // ============================================================
  function selectChapter(type, index) {
    if (type === 'original') {
      state.selectedOriginal = (state.selectedOriginal === index) ? null : index;
    } else {
      state.selectedTraduccio = (state.selectedTraduccio === index) ? null : index;
    }
    
    var containerId = type === 'original' ? 'indexOriginal' : 'indexTraduccio';
    var selected = type === 'original' ? state.selectedOriginal : state.selectedTraduccio;
    document.querySelectorAll('#' + containerId + ' .chapter-item').forEach(function(el, i) {
      el.classList.toggle('selected', i === selected);
    });
    
    updateRevisarButton();
  }

  function updateRevisarButton() {
    var btn = document.getElementById('btnRevisar');
    btn.disabled = (state.selectedOriginal === null || state.selectedTraduccio === null);
  }

  // ============================================================
  //  MODAL
  // ============================================================
  function openModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    var formatted = content.split('\n').filter(function(l) { return l.trim(); })
      .map(function(l) { return '<p>' + l + '</p>'; }).join('');
    document.getElementById('modalBody').innerHTML = formatted;
    document.getElementById('modal').classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeModal(e) {
    if (e && e.target !== document.getElementById('modal')) return;
    document.getElementById('modal').classList.remove('active');
    document.body.style.overflow = '';
  }
  
  document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });

  // Placeholder functions per prompts 3-4
  function generarGlossari() {
    var model = document.getElementById('model').value.trim();
    var apiKey = document.getElementById('apiKey').value.trim();
    var proveidor = document.getElementById('proveidor').value;
    
    if (!model || !apiKey) {
      showStatus('Cal emplenar el Model i l\'API Key.', 'error');
      return;
    }
    if (state.original.chapters.length === 0 || state.traduccio.chapters.length === 0) {
      showStatus('Cal pujar els dos documents primer.', 'error');
      return;
    }
    
    var btn = document.getElementById('btnGlossari');
    btn.disabled = true;
    btn.textContent = '‚è≥ Generant...';
    
    // Agafar els primers 3 cap√≠tols (o menys si n'hi ha menys)
    var numCaps = Math.min(3, state.original.chapters.length, state.traduccio.chapters.length);
    var origText = '';
    var tradText = '';
    for (var i = 0; i < numCaps; i++) {
      origText += state.original.chapters[i].contingut + '\n\n';
      tradText += state.traduccio.chapters[i].contingut + '\n\n';
    }
    
    // Limitar text per no superar l√≠mits de tokens
    origText = origText.substring(0, 15000);
    tradText = tradText.substring(0, 15000);
    
    google.script.run
      .withSuccessHandler(function(result) {
        state.glossari = result;
        document.getElementById('glossariContent').textContent = result;
        document.getElementById('glossariContent').classList.remove('empty');
        btn.disabled = false;
        btn.textContent = 'üîç Regenerar Glossari';
        showStatus('Glossari generat correctament!', 'success');
      })
      .withFailureHandler(function(err) {
        showStatus('Error generant glossari: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'üîç Generar Glossari';
      })
      .generarGlossari(origText, tradText, model, apiKey, proveidor);
  }

  function revisarSeleccio() {
    var iOrig = state.selectedOriginal;
    var iTrad = state.selectedTraduccio;
    
    if (iOrig === null || iTrad === null) return;
    
    var model = document.getElementById('model').value.trim();
    var apiKey = document.getElementById('apiKey').value.trim();
    var proveidor = document.getElementById('proveidor').value;
    
    if (!model || !apiKey) {
      showStatus('Cal emplenar el Model i l\'API Key.', 'error');
      return;
    }
    
    var origChapter = state.original.chapters[iOrig];
    var tradChapter = state.traduccio.chapters[iTrad];
    
    // Marcar com a processant
    state.processing['o' + iOrig] = true;
    state.processing['t' + iTrad] = true;
    renderIndexes();
    
    // Re-seleccionar visualment despr√©s del renderitzat
    selectChapter('original', iOrig);
    selectChapter('traduccio', iTrad);
    
    document.getElementById('btnRevisar').disabled = true;
    document.getElementById('btnRevisar').textContent = '‚è≥ Revisant...';
    
    google.script.run
      .withSuccessHandler(function(result) {
        delete state.processing['o' + iOrig];
        delete state.processing['t' + iTrad];
        
        // Afegir la revisi√≥ a la llista
        state.revisions.push({
          titol: tradChapter.titol,
          contingut: result,
          indexOrig: iOrig,
          indexTrad: iTrad
        });
        
        renderIndexes();
        renderTranslations();
        showStatus('Cap√≠tol "' + tradChapter.titol + '" revisat correctament!', 'success');
        
        document.getElementById('btnRevisar').disabled = false;
        document.getElementById('btnRevisar').textContent = 'üîÑ Revisar Cap√≠tol';
        
        // Actualitzar comptador a la pestanya
        document.getElementById('translationCount').textContent = '(' + state.revisions.length + ')';
      })
      .withFailureHandler(function(err) {
        delete state.processing['o' + iOrig];
        delete state.processing['t' + iTrad];
        renderIndexes();
        showStatus('Error en la revisi√≥: ' + err.message, 'error');
        document.getElementById('btnRevisar').disabled = false;
        document.getElementById('btnRevisar').textContent = 'üîÑ Revisar Cap√≠tol';
      })
      .revisarCapitol(
        origChapter.contingut,
        tradChapter.contingut,
        model,
        apiKey,
        proveidor,
        state.glossari
      );
  }

  function renderTranslations() {
    var container = document.getElementById('translationsList');
    
    if (state.revisions.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div>' +
        '<p>Encara no hi ha cap cap√≠tol revisat.<br>Ves a Configuraci√≥ per comen√ßar.</p></div>';
      document.getElementById('epubSection').style.display = 'none';
      return;
    }
    
    container.innerHTML = '';
    var list = document.createElement('div');
    list.className = 'translation-list';
    
    state.revisions.forEach(function(rev, i) {
      var item = document.createElement('div');
      item.className = 'translation-item';
      item.onclick = function() { openModal(rev.titol, rev.contingut); };
      
      var num = document.createElement('span');
      num.className = 'num';
      num.textContent = i + 1;
      item.appendChild(num);
      
      var title = document.createElement('span');
      title.className = 'title';
      title.textContent = rev.titol;
      item.appendChild(title);
      
      list.appendChild(item);
    });
    
    container.appendChild(list);
    document.getElementById('epubSection').style.display = '';
  }
  function generarEPUB() {
    if (state.revisions.length === 0) {
      showStatus('No hi ha cap√≠tols revisats per generar l\'EPUB.', 'error');
      return;
    }
    
    var zip = new JSZip();
    var titolLlibre = 'Traduccia ‚Äî Revisi√≥';
    
    // 1. mimetype (OBLIGAT√íRIAMENT sense compressi√≥ i com a primer fitxer)
    zip.file('mimetype', 'application/epub+zip', {compression: 'STORE'});
    
    // 2. META-INF/container.xml
    zip.file('META-INF/container.xml', [
      '<?xml version="1.0" encoding="UTF-8"?>',
      '<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">',
      '  <rootfiles>',
      '    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>',
      '  </rootfiles>',
      '</container>'
    ].join('\n'));
    
    // 3. Estil CSS per l'EPUB
    var css = [
      'body { font-family: Georgia, "Times New Roman", serif; line-height: 1.6; margin: 1em; color: #1a1a1a; }',
      'h1 { font-size: 1.5em; margin: 1em 0 0.5em; page-break-before: always; }',
      'h1:first-child { page-break-before: avoid; }',
      'p { margin: 0.4em 0; text-indent: 1.5em; text-align: justify; }',
      'nav ol { list-style-type: decimal; padding-left: 1.5em; }',
      'nav li { margin: 0.3em 0; }',
      'nav a { text-decoration: none; color: #2563eb; }'
    ].join('\n');
    zip.file('OEBPS/style.css', css);
    
    // 4. Generar cap√≠tols XHTML
    var manifestItems = '';
    var spineItems = '';
    
    // Afegir CSS al manifest
    manifestItems += '    <item id="css" href="style.css" media-type="text/css"/>\n';
    
    // Afegir TOC
    manifestItems += '    <item id="toc" href="toc.xhtml" media-type="application/xhtml+xml" properties="nav"/>\n';
    spineItems += '    <itemref idref="toc"/>\n';
    
    state.revisions.forEach(function(rev, i) {
      var id = 'cap' + i;
      manifestItems += '    <item id="' + id + '" href="' + id + '.xhtml" media-type="application/xhtml+xml"/>\n';
      spineItems += '    <itemref idref="' + id + '"/>\n';
      
      // Convertir el text en par√†grafs XHTML
      var paras = rev.contingut
        .split('\n')
        .filter(function(l) { return l.trim(); })
        .map(function(l) { return '<p>' + escapeXml(l) + '</p>'; })
        .join('\n');
      
      var chapterXhtml = [
        '<?xml version="1.0" encoding="UTF-8"?>',
        '<!DOCTYPE html>',
        '<html xmlns="http://www.w3.org/1999/xhtml">',
        '<head>',
        '  <title>' + escapeXml(rev.titol) + '</title>',
        '  <link rel="stylesheet" href="style.css"/>',
        '</head>',
        '<body>',
        '  <h1>' + escapeXml(rev.titol) + '</h1>',
        '  ' + paras,
        '</body>',
        '</html>'
      ].join('\n');
      
      zip.file('OEBPS/' + id + '.xhtml', chapterXhtml);
    });
    
    // 5. content.opf (manifest + spine + metadata)
    var now = new Date().toISOString().replace(/\.\d+Z$/, 'Z');
    var contentOpf = [
      '<?xml version="1.0" encoding="UTF-8"?>',
      '<package xmlns="http://www.idpf.org/2007/opf" version="3.0" unique-identifier="uid">',
      '  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">',
      '    <dc:identifier id="uid">traduccia-' + Date.now() + '</dc:identifier>',
      '    <dc:title>' + escapeXml(titolLlibre) + '</dc:title>',
      '    <dc:language>ca</dc:language>',
      '    <meta property="dcterms:modified">' + now + '</meta>',
      '  </metadata>',
      '  <manifest>',
      manifestItems,
      '  </manifest>',
      '  <spine>',
      spineItems,
      '  </spine>',
      '</package>'
    ].join('\n');
    
    zip.file('OEBPS/content.opf', contentOpf);
    
    // 6. TOC (nav XHTML)
    var tocItems = state.revisions.map(function(rev, i) {
      return '      <li><a href="cap' + i + '.xhtml">' + escapeXml(rev.titol) + '</a></li>';
    }).join('\n');
    
    var tocXhtml = [
      '<?xml version="1.0" encoding="UTF-8"?>',
      '<!DOCTYPE html>',
      '<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">',
      '<head>',
      '  <title>√çndex</title>',
      '  <link rel="stylesheet" href="style.css"/>',
      '</head>',
      '<body>',
      '  <nav epub:type="toc">',
      '    <h1>√çndex</h1>',
      '    <ol>',
      tocItems,
      '    </ol>',
      '  </nav>',
      '</body>',
      '</html>'
    ].join('\n');
    
    zip.file('OEBPS/toc.xhtml', tocXhtml);
    
    // 7. Generar i descarregar
    showStatus('Generant EPUB...', 'success');
    
    zip.generateAsync({
      type: 'blob',
      mimeType: 'application/epub+zip',
      compression: 'DEFLATE',
      compressionOptions: { level: 9 }
    })
    .then(function(blob) {
      var filename = 'traduccia_revisio_' + new Date().toISOString().slice(0,10) + '.epub';
      saveAs(blob, filename);
      showStatus('EPUB generat i descarregat: ' + filename, 'success');
    })
    .catch(function(err) {
      showStatus('Error generant EPUB: ' + err.message, 'error');
    });
  }
</script>

</body>
</html>
