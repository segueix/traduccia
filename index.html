<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NovelÂ·la IA</title>
<style>
  :root {
    --bg:        #0f0f13;
    --surface:   #1a1a24;
    --surface2:  #22222f;
    --border:    #2e2e42;
    --accent:    #7c6af7;
    --accent2:   #a78bfa;
    --text:      #e8e8f0;
    --text2:     #9898b0;
    --success:   #4ade80;
    --warning:   #fbbf24;
    --radius:    12px;
    --font:      'Segoe UI', system-ui, sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px 60px;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    width: 100%;
    max-width: 860px;
    text-align: center;
    margin-bottom: 32px;
  }
  header h1 {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }
  header p { color: var(--text2); font-size: .95rem; }

  /* â”€â”€ Progress bar â”€â”€ */
  #progress-wrap {
    width: 100%;
    max-width: 860px;
    margin-bottom: 28px;
  }
  .progress-steps {
    display: flex;
    gap: 6px;
    align-items: center;
    overflow-x: auto;
    padding-bottom: 4px;
  }
  .step-pill {
    flex-shrink: 0;
    padding: 5px 14px;
    border-radius: 99px;
    font-size: .75rem;
    font-weight: 600;
    background: var(--surface2);
    color: var(--text2);
    border: 1px solid var(--border);
    transition: all .3s;
  }
  .step-pill.done     { background: #2a2a3d; color: var(--accent2); border-color: var(--accent); }
  .step-pill.active   { background: var(--accent); color: #fff; border-color: var(--accent); }
  .step-arrow { color: var(--border); font-size: .8rem; flex-shrink: 0; }

  /* â”€â”€ Card â”€â”€ */
  .card {
    width: 100%;
    max-width: 860px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 20px;
  }
  .card h2 {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 18px;
    color: var(--accent2);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .card h2 .icon { font-size: 1.4rem; }

  /* â”€â”€ Select â”€â”€ */
  select {
    width: 100%;
    padding: 12px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 1rem;
    font-family: var(--font);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%239898b0' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }
  select:focus { outline: none; border-color: var(--accent); }

  input[type=text],
  input[type=password] {
    width: 100%;
    padding: 12px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: .95rem;
    font-family: var(--font);
  }
  input[type=text]:focus,
  input[type=password]:focus { outline: none; border-color: var(--accent); }

  .field-label {
    display: block;
    font-size: .85rem;
    color: var(--text2);
    margin: 14px 0 8px;
  }

  /* â”€â”€ Botons â”€â”€ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 11px 24px;
    border-radius: 8px;
    font-size: .95rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all .2s;
    font-family: var(--font);
  }
  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: #6b5be0; transform: translateY(-1px); }
  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent2); }
  .btn:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }
  .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }

  /* â”€â”€ Llista de premisses â”€â”€ */
  .premise-list { display: flex; flex-direction: column; gap: 10px; }
  .premise-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all .2s;
  }
  .premise-item:hover  { border-color: var(--accent); }
  .premise-item.chosen { border-color: var(--accent); background: #1e1b38; }
  .premise-item input[type=radio] { margin-top: 2px; accent-color: var(--accent); flex-shrink: 0; }
  .premise-item label { cursor: pointer; line-height: 1.5; font-size: .95rem; }

  /* â”€â”€ Opcions dobles â”€â”€ */
  .options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 640px) { .options-grid { grid-template-columns: 1fr; } }
  .option-card {
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    cursor: pointer;
    transition: all .2s;
    position: relative;
  }
  .option-card:hover  { border-color: var(--accent); }
  .option-card.chosen { border-color: var(--accent); background: #1e1b38; }
  .option-card .opt-label {
    display: inline-block;
    background: var(--accent);
    color: #fff;
    font-size: .7rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 99px;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: .06em;
  }
  .option-card.chosen .opt-label { background: var(--success); }
  .option-card pre {
    white-space: pre-wrap;
    font-family: var(--font);
    font-size: .88rem;
    line-height: 1.65;
    color: var(--text);
  }
  .opt-check {
    position: absolute;
    top: 14px;
    right: 14px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .9rem;
    transition: all .2s;
  }
  .option-card.chosen .opt-check { background: var(--success); border-color: var(--success); color: #fff; }

  /* â”€â”€ CapÃ­tol escrit â”€â”€ */
  .chapter-content {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    white-space: pre-wrap;
    font-size: .95rem;
    line-height: 1.8;
    color: var(--text);
    font-family: 'Georgia', serif;
    max-height: 500px;
    overflow-y: auto;
  }
  .chapter-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent2);
    margin-bottom: 16px;
    font-family: 'Georgia', serif;
  }

  /* â”€â”€ Taula de capÃ­tols â”€â”€ */
  .chapter-table { width: 100%; border-collapse: collapse; margin-top: 4px; }
  .chapter-table th {
    background: var(--surface2);
    padding: 10px 14px;
    text-align: left;
    font-size: .8rem;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: .06em;
    border-bottom: 1px solid var(--border);
  }
  .chapter-table td {
    padding: 11px 14px;
    font-size: .9rem;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
    line-height: 1.5;
  }
  .chapter-table tr:last-child td { border-bottom: none; }
  .chapter-table .ch-num {
    color: var(--accent2);
    font-weight: 700;
    white-space: nowrap;
    width: 80px;
  }
  .chapter-table tr.writing td { background: #1e1b38; }
  .chapter-table tr.done td    { opacity: .5; }
  .ch-status { font-size: .75rem; }
  .ch-status.pendent  { color: var(--text2); }
  .ch-status.escrivint { color: var(--warning); }
  .ch-status.fet       { color: var(--success); }

  /* â”€â”€ Loader â”€â”€ */
  .loader-wrap {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 28px 0;
    color: var(--text2);
    font-size: .9rem;
  }
  .loader-wrap.visible { display: flex; }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Toast â”€â”€ */
  #toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 24px;
    border-radius: 99px;
    font-size: .9rem;
    transition: transform .3s;
    z-index: 9999;
    pointer-events: none;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€ BÃ­blia resum â”€â”€ */
  .biblia-item {
    display: flex;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: .88rem;
    line-height: 1.5;
  }
  .biblia-item:last-child { border-bottom: none; }
  .biblia-label {
    flex-shrink: 0;
    width: 110px;
    color: var(--text2);
    font-size: .8rem;
    text-transform: uppercase;
    letter-spacing: .05em;
    padding-top: 1px;
  }
  .biblia-val { color: var(--text); }

  /* â”€â”€ Export â”€â”€ */
  .export-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--accent2);
    text-decoration: none;
    font-size: .9rem;
    font-weight: 600;
    padding: 8px 16px;
    border: 1px solid var(--accent);
    border-radius: 8px;
    transition: all .2s;
  }
  .export-link:hover { background: #1e1b38; }

  /* â”€â”€ SecciÃ³ amagada â”€â”€ */
  .hidden { display: none !important; }
</style>
</head>
<body>

<header>
  <h1>ğŸ“– NovelÂ·la IA</h1>
  <p>Construeix la teva obra pas a pas amb intelÂ·ligÃ¨ncia artificial</p>
</header>


<!-- CONFIGURACIÃ“ INICIAL -->
<div class="card" id="card-config">
  <h2><span class="icon">âš™ï¸</span> ConfiguraciÃ³</h2>
  <p style="color:var(--text2);margin-bottom:8px;">Configura el model abans de comenÃ§ar l'assistent.</p>

  <label class="field-label" for="config-provider">ProveÃ¯dor</label>
  <select id="config-provider">
    <option value="openai">OpenAI (GPT-4)</option>
    <option value="anthropic">Anthropic (Claude 3.5)</option>
    <option value="gemini">Google (Gemini 1.5)</option>
  </select>

  <label class="field-label" for="config-apikey">API Key</label>
  <input type="password" id="config-apikey" placeholder="Enganxa aquÃ­ la teva API key">

  <div class="btn-row">
    <button class="btn btn-primary" onclick="guardarIComencar()">Guardar i ComenÃ§ar</button>
  </div>
</div>

<!-- Progress -->
<div id="progress-wrap" class="hidden">
  <div class="progress-steps" id="steps-bar">
    <div class="step-pill active" data-step="0">TemÃ tica</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="1">Premissa</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="2">Estructura</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="3">Personatges</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="4">DesenllaÃ§</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="5">BÃ­blia</div>
    <div class="step-arrow">â€º</div>
    <div class="step-pill" data-step="6">Escriptura</div>
  </div>
</div>

<!-- FASE 0: SelecciÃ³ de temÃ tica -->
<div class="card hidden" id="fase-0">
  <h2><span class="icon">ğŸ­</span> Tria la temÃ tica</h2>
  <label class="field-label" for="sel-tematica">GÃ¨nere literari</label>
  <select id="sel-tematica">
    <option value="">â€” Selecciona un gÃ¨nere â€”</option>
    <option value="novelÂ·la d'aventures">NovelÂ·la d'aventures</option>
    <option value="ciÃ¨ncia ficciÃ³">CiÃ¨ncia ficciÃ³</option>
    <option value="fantasia Ã¨pica">Fantasia Ã¨pica</option>
    <option value="novelÂ·la histÃ²rica">NovelÂ·la histÃ²rica</option>
    <option value="novelÂ·la romÃ ntica">NovelÂ·la romÃ ntica</option>
    <option value="thriller i misteri">Thriller i misteri</option>
    <option value="terror psicolÃ²gic">Terror psicolÃ²gic</option>
    <option value="drama contemporani">Drama contemporani</option>
    <option value="conte literari">Conte literari</option>
    <option value="novelÂ·la grÃ fica narrativa">Art i novelÂ·la grÃ fica narrativa</option>
  </select>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="iniciarFase1()">âœ¨ Generar premisses</button>
  </div>
</div>

<!-- FASE 1: SelecciÃ³ de premissa -->
<div class="card hidden" id="fase-1">
  <h2><span class="icon">ğŸ’¡</span> Tria la premissa</h2>
  <div class="loader-wrap" id="loader-1">
    <div class="spinner"></div>
    <span>Generant 10 premissesâ€¦</span>
  </div>
  <div id="llista-premisses" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase1" onclick="iniciarFase2()">ğŸ—ï¸ Construir estructura</button>
  </div>
</div>

<!-- FASE 2: Estructura narrativa -->
<div class="card hidden" id="fase-2">
  <h2><span class="icon">ğŸ—ï¸</span> Tria la trama</h2>
  <div class="loader-wrap" id="loader-2">
    <div class="spinner"></div>
    <span>Generant 10 trames possiblesâ€¦</span>
  </div>
  <div id="llista-estructures" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase2" onclick="iniciarFase3()">ğŸ‘¤ Triar protagonista</button>
  </div>
</div>

<!-- FASE 3: Personatges -->
<div class="card hidden" id="fase-3">
  <h2><span class="icon">ğŸ‘¥</span> Tria el protagonista</h2>
  <div class="loader-wrap" id="loader-3">
    <div class="spinner"></div>
    <span>Generant 10 protagonistes possiblesâ€¦</span>
  </div>
  <div id="llista-personatges" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase3" onclick="iniciarFase4()">ğŸ Definir desenllaÃ§</button>
  </div>
</div>

<!-- FASE 4: DesenllaÃ§ -->
<div class="card hidden" id="fase-4">
  <h2><span class="icon">ğŸ</span> Tria el desenllaÃ§</h2>
  <div class="loader-wrap" id="loader-4">
    <div class="spinner"></div>
    <span>Generant 10 desenllaÃ§os possiblesâ€¦</span>
  </div>
  <div id="llista-desenllac" class="premise-list"></div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase4" onclick="iniciarFase5()">ğŸ“‹ Generar taula de capÃ­tols</button>
  </div>
</div>

<!-- FASE 5: Taula de capÃ­tols -->
<div class="card hidden" id="fase-5">
  <h2><span class="icon">ğŸ“‹</span> Taula de capÃ­tols</h2>
  <div class="loader-wrap" id="loader-5">
    <div class="spinner"></div>
    <span>Generant l'estructura de capÃ­tolsâ€¦</span>
  </div>
  <div id="taula-capitols-wrap" class="hidden">
    <table class="chapter-table" id="taula-capitols">
      <thead>
        <tr>
          <th>CapÃ­tol</th>
          <th>TÃ­tol</th>
          <th>Objectiu narratiu</th>
          <th>Estat</th>
        </tr>
      </thead>
      <tbody id="capitols-tbody"></tbody>
    </table>
  </div>
  <div class="btn-row">
    <button class="btn btn-primary hidden" id="btn-fase5" onclick="iniciarEscriptura()">âœï¸ Escriure la novelÂ·la</button>
  </div>
</div>

<!-- FASE 6: Escriptura de capÃ­tols -->
<div class="card hidden" id="fase-6">
  <h2><span class="icon">âœï¸</span> Escriptura â€” <span id="titol-capitol-actual">â€”</span></h2>
  <div class="loader-wrap" id="loader-6">
    <div class="spinner"></div>
    <span id="loader-6-text">Escrivint capÃ­tolâ€¦</span>
  </div>
  <div id="capitol-escrit" class="hidden">
    <div class="chapter-title" id="capitol-titol-h"></div>
    <div class="chapter-content" id="capitol-cos"></div>
    <div class="btn-row" style="margin-top:16px;">
      <button class="btn btn-primary" id="btn-seguent-capitol" onclick="seguentCapitol()">â–¶ CapÃ­tol segÃ¼ent</button>
      <button class="btn btn-secondary" onclick="regenerarCapitol()">ğŸ”„ Regenerar</button>
    </div>
  </div>
</div>

<!-- BÃ­blia resum (lateral inferior) -->
<div class="card hidden" id="card-biblia">
  <h2><span class="icon">ğŸ“š</span> BÃ­blia narrativa</h2>
  <div id="biblia-contingut"></div>
</div>

<!-- Export final -->
<div id="export-wrap" class="hidden" style="width:100%;max-width:860px;margin-bottom:20px;">
  <div class="card">
    <h2><span class="icon">ğŸ‰</span> NovelÂ·la completada!</h2>
    <p style="color:var(--text2);margin-bottom:16px;">Tots els capÃ­tols han estat generats. Pots exportar-la a Google Docs.</p>
    <button class="btn btn-primary" onclick="exportarDoc()">ğŸ“„ Exportar a Google Docs</button>
    <div id="export-link-wrap" class="hidden" style="margin-top:14px;"></div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTAT GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ESTAT = {
  fase:           0,
  tematica:       '',
  history:        [],
  premissaTriada: '',
  estructuraTriada:'',
  personatgeTriat:'',
  desenllacTriat: '',
  capitols:       [],      // [{num, titol, text}]
  capitalActual:  0,
  novellaTextos:  []       // textos dels capÃ­tols escrits
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITATS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCard(id)  { document.getElementById(id).classList.remove('hidden'); }
function hideCard(id)  { document.getElementById(id).classList.add('hidden'); }
function showLoader(n) { document.getElementById('loader-' + n).classList.add('visible'); }
function hideLoader(n) { document.getElementById('loader-' + n).classList.remove('visible'); }
function showBtn(id)   { document.getElementById(id).classList.remove('hidden'); }
function hideBtn(id)   { document.getElementById(id).classList.add('hidden'); }

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function updateProgress(fase) {
  document.querySelectorAll('.step-pill').forEach(el => {
    const s = parseInt(el.dataset.step);
    el.classList.remove('active', 'done');
    if (s < fase)  el.classList.add('done');
    if (s === fase) el.classList.add('active');
  });
}

function actualitzarBiblia() {
  const b = document.getElementById('biblia-contingut');
  const items = [
    ['TemÃ tica',     ESTAT.tematica        || 'â€”'],
    ['Premissa',     ESTAT.premissaTriada  || 'â€”'],
    ['Trama',        ESTAT.estructuraTriada ? ESTAT.estructuraTriada.substring(0,80)+'â€¦' : 'â€”'],
    ['Protagonista', ESTAT.personatgeTriat ? ESTAT.personatgeTriat.substring(0,80)+'â€¦' : 'â€”'],
    ['DesenllaÃ§',    ESTAT.desenllacTriat  ? ESTAT.desenllacTriat.substring(0,80)+'â€¦' : 'â€”'],
  ];
  b.innerHTML = items.map(([l,v]) =>
    `<div class="biblia-item"><div class="biblia-label">${l}</div><div class="biblia-val">${v}</div></div>`
  ).join('');
  showCard('card-biblia');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 1 â€” Premisses
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let USER_CONFIG = null;

function guardarIComencar() {
  const provider = document.getElementById('config-provider').value;
  const apiKey = document.getElementById('config-apikey').value.trim();

  if (!provider) {
    toast('Selecciona un proveÃ¯dor.');
    return;
  }
  if (!apiKey) {
    toast('Introdueix una API key.');
    return;
  }

  const modelByProvider = {
    openai: 'gpt-4o',
    anthropic: 'claude-3-5-sonnet-20241022',
    gemini: 'gemini-1.5-pro'
  };

  USER_CONFIG = {
    provider,
    apiKey,
    model: modelByProvider[provider] || ''
  };

  hideCard('card-config');
  document.getElementById('progress-wrap').classList.remove('hidden');
  showCard('fase-0');
  toast('ConfiguraciÃ³ guardada. Ja pots comenÃ§ar.');
}

function iniciarFase1() {
  const sel = document.getElementById('sel-tematica').value;
  if (!sel) { toast('Selecciona primer una temÃ tica.'); return; }

  if (!USER_CONFIG) { toast('Primer has de guardar la configuraciÃ³ inicial.'); return; }

  ESTAT.tematica = sel;
  ESTAT.history  = [];
  ESTAT.fase     = 1;
  updateProgress(1);
  showCard('fase-1');
  showLoader(1);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(1);
      renderPremisses(res.response);
    })
    .withFailureHandler(err => {
      hideLoader(1);
      toast('Error: ' + err.message);
    })
    .fase1_premisses(sel, [], USER_CONFIG);
}

function renderPremisses(text) {
  const wrap = document.getElementById('llista-premisses');
  // Parseig local
  const lines = text.split('\n').filter(l => /^\d+\./.test(l.trim()));
  if (lines.length === 0) {
    wrap.innerHTML = `<pre style="white-space:pre-wrap;font-size:.9rem;">${text}</pre>`;
  } else {
    wrap.innerHTML = lines.map((l, i) => {
      const txt = l.replace(/^\d+\.\s*/, '').trim();
      return `<div class="premise-item" id="prem-${i}" onclick="triarPremissa(${i}, this)">
        <input type="radio" name="prem" id="r-${i}">
        <label for="r-${i}">${txt}</label>
      </div>`;
    }).join('');
  }
  ESTAT._premissaLista = lines.map(l => l.replace(/^\d+\.\s*/, '').trim());
  showBtn('btn-fase1');
}

function triarPremissa(idx, el) {
  document.querySelectorAll('.premise-item').forEach(e => e.classList.remove('chosen'));
  el.classList.add('chosen');
  el.querySelector('input').checked = true;
  ESTAT._premissaIdx = idx;
}

function iniciarFase2() {
  const idx = ESTAT._premissaIdx;
  if (idx === undefined || idx === null) { toast("Tria una premissa primer."); return; }
  ESTAT.premissaTriada = ESTAT._premissaLista[idx];
  ESTAT.fase = 2;
  updateProgress(2);
  actualitzarBiblia();
  showCard('fase-2');
  showLoader(2);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(2);
      renderLlistaSeleccionable(res.response, 'llista-estructures', '_llistaTrames', '_idxTrama', 'btn-fase2');
    })
    .withFailureHandler(err => { hideLoader(2); toast('Error: ' + err.message); })
    .fase2_estructura(ESTAT.premissaTriada, ESTAT.history, USER_CONFIG);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS DE LLISTA NUMERADA (10 OPCIONS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLlistaSeleccionable(text, wrapId, stateListKey, selectedIdxKey, btnId) {
  const wrap = document.getElementById(wrapId);
  const lines = text.split('\n').filter(l => /^\d+\./.test(l.trim()));

  if (lines.length === 0) {
    wrap.innerHTML = `<pre style="white-space:pre-wrap;font-size:.9rem;">${escHtml(text)}</pre>`;
    window[stateListKey] = [];
    return;
  }

  const list = lines.map(l => l.replace(/^\d+\.\s*/, '').trim());
  window[stateListKey] = list;
  ESTAT[selectedIdxKey] = null;

  wrap.innerHTML = list.map((item, i) => `
    <div class="premise-item" id="${wrapId}-item-${i}" onclick="triarDeLlista('${wrapId}', '${selectedIdxKey}', ${i}, this)">
      <input type="radio" name="${wrapId}-radio" id="${wrapId}-r-${i}">
      <label for="${wrapId}-r-${i}">${escHtml(item)}</label>
    </div>
  `).join('');

  showBtn(btnId);
}

function triarDeLlista(wrapId, selectedIdxKey, idx, el) {
  document.querySelectorAll(`#${wrapId} .premise-item`).forEach(e => e.classList.remove('chosen'));
  el.classList.add('chosen');
  const radio = el.querySelector('input[type=radio]');
  if (radio) radio.checked = true;
  ESTAT[selectedIdxKey] = idx;
}

function getSeleccioLlista(stateListKey, selectedIdxKey) {
  const list = window[stateListKey] || [];
  const idx = ESTAT[selectedIdxKey];
  if (idx === null || idx === undefined || !list[idx]) return null;
  return list[idx];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 3 â€” Personatges
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase3() {
  const tri = getSeleccioLlista('_llistaTrames', '_idxTrama');
  if (!tri) { toast('Tria una trama.'); return; }
  ESTAT.estructuraTriada = tri;
  ESTAT.fase = 3;
  updateProgress(3);
  actualitzarBiblia();
  showCard('fase-3');
  showLoader(3);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(3);
      renderLlistaSeleccionable(res.response, 'llista-personatges', '_llistaProtagonistes', '_idxProtagonista', 'btn-fase3');
    })
    .withFailureHandler(err => { hideLoader(3); toast('Error: ' + err.message); })
    .fase3_personatges(ESTAT.estructuraTriada, ESTAT.history, USER_CONFIG);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 4 â€” DesenllaÃ§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase4() {
  const tri = getSeleccioLlista('_llistaProtagonistes', '_idxProtagonista');
  if (!tri) { toast('Tria un protagonista.'); return; }
  ESTAT.personatgeTriat = tri;
  ESTAT.fase = 4;
  updateProgress(4);
  actualitzarBiblia();
  showCard('fase-4');
  showLoader(4);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(4);
      renderLlistaSeleccionable(res.response, 'llista-desenllac', '_llistaDesenllacos', '_idxDesenllac', 'btn-fase4');
    })
    .withFailureHandler(err => { hideLoader(4); toast('Error: ' + err.message); })
    .fase4_desenllac(ESTAT.personatgeTriat, ESTAT.history, USER_CONFIG);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 5 â€” BÃ­blia i taula de capÃ­tols
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarFase5() {
  const tri = getSeleccioLlista('_llistaDesenllacos', '_idxDesenllac');
  if (!tri) { toast('Tria un desenllaÃ§.'); return; }
  ESTAT.desenllacTriat = tri;
  ESTAT.fase = 5;
  updateProgress(5);
  actualitzarBiblia();
  showCard('fase-5');
  showLoader(5);

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      hideLoader(5);
      renderTaulaCapitols(res.response);
    })
    .withFailureHandler(err => { hideLoader(5); toast('Error: ' + err.message); })
    .fase5_compilarBiblia(ESTAT.desenllacTriat, ESTAT.history, USER_CONFIG);
}

function renderTaulaCapitols(text) {
  // Parseig capÃ­tols: busca blocs separats per "---"
  const blocks = text.split('---').map(b => b.trim()).filter(b => b.length > 0);
  const capitols = [];
  blocks.forEach(block => {
    const m = block.match(/\*\*CapÃ­tol\s+(\d+):\s*(.+?)\*\*/i);
    if (m) {
      capitols.push({ num: parseInt(m[1]), titol: m[2].trim(), text: block });
    }
  });

  if (capitols.length === 0) {
    // Fallback: text complet
    document.getElementById('taula-capitols-wrap').innerHTML =
      `<pre style="white-space:pre-wrap;font-size:.88rem;">${text}</pre>`;
  } else {
    ESTAT.capitols = capitols;
    const tbody = document.getElementById('capitols-tbody');
    tbody.innerHTML = capitols.map(c => `
      <tr id="tr-cap-${c.num}">
        <td class="ch-num">Cap. ${c.num}</td>
        <td>${escHtml(c.titol)}</td>
        <td>${escHtml(extractObjNarratiu(c.text))}</td>
        <td><span class="ch-status pendent" id="st-cap-${c.num}">Pendent</span></td>
      </tr>
    `).join('');
  }
  document.getElementById('taula-capitols-wrap').classList.remove('hidden');
  showBtn('btn-fase5');
}

function extractObjNarratiu(text) {
  const m = text.match(/Objectiu narratiu:\s*(.+)/i);
  return m ? m[1].trim() : '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FASE 6 â€” Escriptura de capÃ­tols
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function iniciarEscriptura() {
  ESTAT.fase          = 6;
  ESTAT.capitalActual = 0;
  ESTAT.novellaTextos = [];
  updateProgress(6);
  showCard('fase-6');
  escriureCapitolActual();
}

function escriureCapitolActual() {
  const cap     = ESTAT.capitols[ESTAT.capitalActual];
  const total   = ESTAT.capitols.length;
  const numCap  = cap.num;
  const titol   = cap.titol;

  document.getElementById('titol-capitol-actual').textContent = `CapÃ­tol ${numCap}: ${titol}`;
  document.getElementById('loader-6-text').textContent = `Escrivint capÃ­tol ${numCap} de ${total}â€¦`;
  hideCard('capitol-escrit');
  showLoader(6);

  // Marcar a la taula
  const tr = document.getElementById('tr-cap-' + numCap);
  if (tr) tr.classList.add('writing');
  const st = document.getElementById('st-cap-' + numCap);
  if (st) { st.textContent = 'âœï¸ Escrivintâ€¦'; st.className = 'ch-status escrivint'; }

  // Actualitzar botÃ³ "CapÃ­tol segÃ¼ent" / "Finalitzar"
  const btnSeg = document.getElementById('btn-seguent-capitol');
  if (ESTAT.capitalActual < total - 1) {
    btnSeg.textContent = `â–¶ CapÃ­tol ${numCap + 1}`;
    btnSeg.style.display = '';
  } else {
    btnSeg.textContent = 'ğŸ Finalitzar';
    btnSeg.style.display = '';
  }

  google.script.run
    .withSuccessHandler(res => {
      ESTAT.history = res.history;
      ESTAT.novellaTextos.push({ num: numCap, titol, text: res.response });
      hideLoader(6);
      mostrarCapitolEscrit(numCap, titol, res.response);
      // Actualitzar taula
      if (tr) tr.classList.remove('writing');
      if (st) { st.textContent = 'âœ… Fet'; st.className = 'ch-status fet'; }
    })
    .withFailureHandler(err => { hideLoader(6); toast('Error: ' + err.message); })
    .fase6_escriureCapitol(numCap, titol, total, ESTAT.history, USER_CONFIG);
}

function mostrarCapitolEscrit(num, titol, text) {
  document.getElementById('capitol-titol-h').textContent = `CapÃ­tol ${num}: ${titol}`;
  document.getElementById('capitol-cos').textContent     = text;
  showCard('capitol-escrit');
}

function seguentCapitol() {
  ESTAT.capitalActual++;
  if (ESTAT.capitalActual >= ESTAT.capitols.length) {
    // NovelÂ·la completada
    hideCard('fase-6');
    showCard('export-wrap');
    updateProgress(7);
    toast('ğŸ‰ NovelÂ·la completada!');
    return;
  }
  // Scroll a dalt del capÃ­tol
  document.getElementById('fase-6').scrollIntoView({ behavior: 'smooth' });
  escriureCapitolActual();
}

function regenerarCapitol() {
  if (!confirm('Vols regenerar aquest capÃ­tol? El text actual es perdrÃ .')) return;
  // Eliminar Ãºltim text guardat
  ESTAT.novellaTextos.pop();
  // Eliminar Ãºltims 2 missatges (user + assistant) de l'historial
  ESTAT.history = ESTAT.history.slice(0, -2);
  escriureCapitolActual();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT A GOOGLE DOCS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportarDoc() {
  const titol    = ESTAT.premissaTriada.substring(0, 50) + 'â€¦';
  const contingut = ESTAT.novellaTextos.map(c =>
    `**CapÃ­tol ${c.num}: ${c.titol}**\n\n${c.text}`
  ).join('\n\n---\n\n');

  toast('Creant document a Google Docsâ€¦');

  google.script.run
    .withSuccessHandler(url => {
      const wrap = document.getElementById('export-link-wrap');
      wrap.innerHTML = `<a href="${url}" target="_blank" class="export-link">ğŸ“„ Obrir a Google Docs â†’</a>`;
      wrap.classList.remove('hidden');
    })
    .withFailureHandler(err => toast('Error: ' + err.message))
    .exportarADoc(titol, contingut);
}
</script>
</body>
</html>
